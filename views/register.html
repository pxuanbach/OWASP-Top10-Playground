<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="card shadow p-4" style="min-width: 350px; max-width: 400px; width: 100%;">
            <h2 class="mb-4 text-center">Register</h2>
            <div id="register-error" class="mt-2"></div>
            <form id="registerForm" action="/api/register" method="post">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" name="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Register</button>
            </form>
            <div class="mt-3 text-center">
                <a href="/login">Back to Login</a>
            </div>
            <div id="security-level" class="mt-3 text-center text-secondary" style="font-size: 14px;"></div>
            <div class="mt-2 text-center">
                <a href="/config" class="text-decoration-none">
                    <i class="bi bi-gear me-1"></i>Change security level
                </a>
            </div>
            
            <!-- Code Display Section -->
            <div class="mt-3 text-center">
                <button id="show-code-btn" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#codeModal">
                    <i class="bi bi-code-slash me-2"></i>Show Register Code
                </button>
            </div>
        </div>
    </div>
    
    <!-- Code Modal -->
    <div class="modal fade" id="codeModal" tabindex="-1" aria-labelledby="codeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="codeModalLabel">
                        <i class="bi bi-file-earmark-code me-2"></i>Register Implementation 
                        (<span id="code-security-level"></span> security)
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="bg-light p-3 border-bottom">
                        <small class="text-muted">
                            <i class="bi bi-info-circle me-1"></i>
                            This code shows the actual implementation used for the current security level.
                            Compare the differences between low and high security implementations.
                        </small>
                    </div>
                    <pre class="mb-0" style="max-height: 70vh; overflow-y: auto; font-size: 14px; line-height: 1.4;"><code id="register-code" class="language-javascript"></code></pre>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <span class="badge bg-warning text-dark me-2">OWASP A02</span>
                        <small class="text-muted">Cryptographic Failures</small>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Include highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { getSecurityLevel } from '/public/js/securityLevel.js';
        const level = getSecurityLevel();
        const form = document.getElementById('registerForm');
        if (level === 'low') {
            form.action = '/low/api/register';
        } else if (level === 'high') {
            form.action = '/high/api/register';
        }
        document.getElementById('security-level').textContent = 'Security level: ' + level;
        document.getElementById('code-security-level').textContent = level;

        // Show register error if error param exists
        const params = new URLSearchParams(window.location.search);
        const error = params.get('error');
        if (error) {
            document.getElementById('register-error').innerHTML = `<div class="alert alert-danger" role="alert">${decodeURIComponent(error)}</div>`;
        }

        // Code display functionality
        let codeLoaded = false;

        // Load code when modal is shown
        const codeModal = document.getElementById('codeModal');
        codeModal.addEventListener('show.bs.modal', function () {
            if (!codeLoaded) {
                loadRegisterCode();
                codeLoaded = true;
            }
        });

        // Load register code based on security level
        function loadRegisterCode() {
            const codeElement = document.getElementById('register-code');
            
            const registerCodes = {
                low: `// A02 - Low security: plaintext password, no validation, no hash
async function handleRegisterLowSecurity(req, res) {
    const { username, password } = req.body;
    if (!username || !password) {
        return res.status(400).redirect('/register?error=Missing username or password');
    }

    // VULNERABILITY: MD5 hash for password storage (weak hashing)
    const md5Hash = crypto.createHash('md5').update(password).digest('hex');
    console.log('New user with username:', username, 'md5(password):', md5Hash);
    
    // VULNERABILITY: Direct string interpolation (SQL injection risk)
    const query = \`INSERT INTO users (username, password, role) VALUES ('\${username}', '\${md5Hash}', 'user')\`;
    await db.query(query);
    
    res.redirect('/login');
}

// VULNERABILITIES in Low Security:
// 1. MD5 hash for password (easily crackable)
// 2. SQL injection via string interpolation
// 3. No check for existing usernames
// 4. No password strength requirements
// 5. Logs sensitive password hash to console`,
                
                high: `// A02 - High security: validate, hash password, parameterized query
async function handleRegisterHighSecurity(req, res) {
    const { username, password, role } = req.body;
    if (!username || !password) {
        return res.status(400).redirect('/register?error=Missing username or password');
    }

    // Check if user already exists (prevents duplicate accounts)
    const exists = await db.query('SELECT 1 FROM users WHERE username = $1', [username]);
    if (exists.rows.length > 0) {
        return res.status(409).redirect('/register?error=Username already exists');
    }
    
    // Strong password hashing with bcrypt (includes salt)
    const hash = await bcrypt.hash(password, 10);
    
    // Parameterized query prevents SQL injection
    await db.query(
        'INSERT INTO users (username, password, role) VALUES ($1, $2, $3)',
        [username, hash, role || 'user']
    );
    
    res.redirect('/login');
}

// SECURITY FEATURES in High Security:
// 1. bcrypt for password hashing (strong hashing with salt)
// 2. Parameterized queries prevent SQL injection
// 3. Input validation and sanitization
// 4. Default role assignment with fallback`
            };

            const code = registerCodes[level] || '// No code available for this security level';
            codeElement.textContent = code;
            
            // Apply syntax highlighting
            hljs.highlightElement(codeElement);
        }
    </script>
</body>
</html>
